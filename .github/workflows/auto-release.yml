name: Auto Release on Main (SemVer + Release + Major Branch)

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Create a semantic-release config that DOES NOT use @semantic-release/npm
      - name: Write semantic-release config (no npm)
        run: |
          cat > .releaserc.json << 'JSON'
          {
            "branches": ["main"],
            "tagFormat": "v${version}",
            "plugins": [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              ["@semantic-release/github", {
                "successComment": false,
                "failComment": false
              }]
            ]
          }
          JSON

      - name: Semantic Release (tag + GitHub release)
        id: semantic
        uses: cycjimmy/semantic-release-action@v6
        with:
          semantic_version: 24
          repository_url: https://github.com/${{ github.repository }}
          # install only the plugins we actually use (no npm plugin)
          extra_plugins: |
            @semantic-release/commit-analyzer@^13
            @semantic-release/release-notes-generator@^14
            @semantic-release/github@^11
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create branch when version is X.0.0 (major release)
      # Branch name == tag name (e.g. v1.0.0)
      - name: Create branch for major releases (vX.0.0)
        if: >
          steps.semantic.outputs.new_release_published == 'true' &&
          steps.semantic.outputs.new_release_minor_version == '0' &&
          steps.semantic.outputs.new_release_patch_version == '0'
        run: |
          TAG="${{ steps.semantic.outputs.new_release_git_tag }}"
          echo "Major release detected: $TAG"
          git fetch --tags --force
          git push origin "refs/tags/$TAG:refs/heads/$TAG"
