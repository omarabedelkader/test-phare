name: Auto Release on Main

on:
  push:
    branches:
      - main

permissions:
  contents: write       # needed to create tags + releases
  pull-requests: write  # needed to create branches

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch tags and history

      # 1) Determine next semantic version
      - name: Calculate next semantic version
        id: semver
        uses: rawmb/git-tag-bump@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Current tag is read from tags; bump type can be determined via commit messages
          # Default bump is "patch" if nothing else is found
        # This action outputs:
        # - next_version: e.g. 1.0.1
        # - new_tag: the full tag like "v1.0.1"

      # 2) Create Git tag for the new version
      - name: Tag repo
        run: |
          git tag v${{ steps.semver.outputs.next_version }}
          git push origin v${{ steps.semver.outputs.next_version }}

      # 3) GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.semver.outputs.next_version }}
          name: Release v${{ steps.semver.outputs.next_version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4) Optional: Create branch on major release
      - name: Create branch on major releases
        if: startsWith(steps.semver.outputs.next_version, '${{ steps.semver.outputs.next_version.split(\".\")[0] }}.0.0')
        run: |
          BRANCH=release-v${{ steps.semver.outputs.next_version }}
          git checkout -b $BRANCH
          git push origin $BRANCH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
